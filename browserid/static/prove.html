<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>BrowserID - My Account</title>
  <link rel="stylesheet" href="css/style.css"  type="text/css">
</head>
<body onload="display_saved_ids()">
<div id="splash">
  <div class="topquarter">
    <div>
      <a href="/"><div class="title">BrowserID</div></a>
      <div class="subtitle">My Account</div>
    </div>
  </div>
  <div class="bottomhalf">
    <div class="why">
      <p>
        Email Verification
      </p>
    </div>
    <div class="status">
      One moment while we attempt to confirm your email address...
    </div>
  </div>
  <div class="footer">
    <div>
      <div class="right">
        <p><b>BrowserID</b> is an <b>open source experiment</b> into improving identity and authentication on the web, by
          <a href="https://mozillalabs.com">mozilla labs</a>.</p>
      </div>
      <div class="left">
        <p> <a href="https://github.com/mozilla/browserid">Source Code</a>&nbsp;&nbsp;&nbsp;<a href="https://wiki.mozilla.org/Identity/Verified_Email_Protocol">Specification</a>&nbsp;&nbsp;&nbsp;<a href="http://groups.google.com/group/mozilla-labs">Mailing list</a> </p>
        <p class="copyright">Copyright Â© 2011 Mozilla.  All rights reserved. </p>
      </div>
    </div>
  </div>
</div>
</body>
<script src="dialog/jquery-min.js"></script>
<script>
function getParameterByName( name )
{
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return "";
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}

function success() {
  $("div.status").text("Address confirmed!");
  setTimeout(function() {
    $("body").fadeOut(1500, function() {
      // ideally we'll just be able to close this window.  shucks.  works on the iphone.
      try { window.close(); } catch(e) {}

      // if the close didn't work, then let's redirect the the management page where they'll
      // get to see the ids that they've created.
      document.location = '/manage.html';
    });
  }, 1000);
}

function failure(why) {
  $("div.status").text("Error encountered while attempting to confirm your address.  please try again.  (error message: " + why + ")");
}

$(document).ready(function() {
    $.ajax({
      url: '/wsapi/prove_email_ownership?token=' + getParameterByName('token'),
      success: function(status, textStatus, jqXHR) {
        var obj = JSON.parse(status);
        if (obj) {
          success();
        } else {
          failure("unknown");
        }
      },
      error: function() {
        failure("Error Communicating With Server!");
      }
    });
});

</script>
</html>
