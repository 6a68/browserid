navigator.id||(navigator.id={});if(!navigator.id.getVerifiedEmail||navigator.id._getVerifiedEmailIsShimmed){var ipServer="https://browserid.org",isMobile=navigator.userAgent.indexOf("Fennec/")!=-1,Channel=function(){function a(a,b,c){var d=!1;if(a==="*")for(var f in e){if(!e.hasOwnProperty(f))continue;if(f==="*")continue;typeof e[f][b]=="object"&&(d=!0)}else if(e["*"]&&e["*"][b]||e[a]&&e[a][b])d=!0;if(d)throw"A channel already exists which overlaps with origin '"+a+"' and has scope '"+b+"'";typeof e[a]!="object"&&(e[a]={}),e[a][b]=c}function b(a,b){delete e[a][b]}function c(a){return Array.isArray?Array.isArray(a):a.constructor.toString().indexOf("Array")!=-1}var d=Math.floor(Math.random()*1000001),e={},f={},g=function(a){var b=JSON.parse(a.data);if(typeof b!="object")return;var c=a.origin,d=null,g=null,h=null;if(typeof b.method=="string"){var i=b.method.split("::");i.length==2?(d=i[0],h=i[1]):h=b.method}typeof b.id!="undefined"&&(g=b.id),typeof h=="string"?e[c]&&e[c][d]?e[c][d](c,h,b):e["*"]&&e["*"][d]&&e["*"][d](c,h,b):typeof g!="undefined"&&f[g]&&f[g](c,h,b)};return window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent&&window.attachEvent("onmessage",g),{build:function(e){var g=function(a){if(e.debugOutput&&window.console&&window.console.log){try{typeof a!="string"&&(a=JSON.stringify(a))}catch(b){}console.log("["+j+"] "+a)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if(typeof e!="object")throw"Channel build invoked without a proper object argument";if(!e.window||!e.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===e.window)throw"target window is same as present window -- not allowed";var h=!1;if(typeof e.origin=="string"){var i;e.origin==="*"?h=!0:null!==(i=e.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9\.])+(?::\d+)?/))&&(e.origin=i[0],h=!0)}if(!h)throw"Channel.build() called with an invalid origin";if(typeof e.scope!="undefined"){if(typeof e.scope!="string")throw"scope, when specified, must be a string";if(e.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var j=function(){var a="",b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var c=0;c<5;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}(),k={},l={},m={},n=!1,o=[],p=function(a,b,c){var d=!1,e=!1;return{origin:b,invoke:function(b,d){if(!m[a])throw"attempting to invoke a callback of a non-existant transaction: "+a;var e=!1;for(var f=0;f<c.length;f++)if(b===c[f]){e=!0;break}if(!e)throw"request supports no such callback '"+b+"'";s({id:a,callback:b,params:d})},error:function(b,c){e=!0;if(!m[a])throw"error called for non-existant message: "+a;delete m[a],s({id:a,error:b,message:c})},complete:function(b){e=!0;if(!m[a])throw"complete called for non-existant message: "+a;delete m[a],s({id:a,result:b})},delayReturn:function(a){return typeof a=="boolean"&&(d=a===!0),d},completed:function(){return e}}},q=function(a,b,d){if(typeof e.gotMessageObserver=="function")try{e.gotMessageObserver(a,d)}catch(h){g("gotMessageObserver() raised an exception: "+h.toString())}if(d.id&&b){if(k[b]){var i=p(d.id,a,d.callbacks?d.callbacks:[]);m[d.id]={};try{if(d.callbacks&&c(d.callbacks)&&d.callbacks.length>0)for(var j=0;j<d.callbacks.length;j++){var n=d.callbacks[j],o=d.params,q=n.split("/");for(var r=0;r<q.length-1;r++){var s=q[r];typeof o[s]!="object"&&(o[s]={}),o=o[s]}o[q[q.length-1]]=function(){var a=n;return function(b){return i.invoke(a,b)}}()}var t=k[b](i,d.params);!i.delayReturn()&&!i.completed()&&i.complete(t)}catch(h){var u="runtime_error",v=null;typeof h=="string"?v=h:typeof h=="object"&&(h&&c(h)&&h.length==2?(u=h[0],v=h[1]):typeof h.error=="string"&&(u=h.error,h.message?typeof h.message=="string"?v=h.message:h=h.message:v=""));if(v===null)try{v=JSON.stringify(h)}catch(w){v=h.toString()}i.error(u,v)}}}else d.id&&d.callback?!l[d.id]||!l[d.id].callbacks||!l[d.id].callbacks[d.callback]?g("ignoring invalid callback, id:"+d.id+" ("+d.callback+")"):l[d.id].callbacks[d.callback](d.params):d.id?l[d.id]?(d.error?(1,l[d.id].error)(d.error,d.message):d.result!==undefined?(1,l[d.id].success)(d.result):(1,l[d.id].success)(),delete l[d.id],delete f[d.id]):g("ignoring invalid response: "+d.id):b&&k[b]&&k[b](null,d.params)};a(e.origin,typeof e.scope=="string"?e.scope:"",q);var r=function(a){return typeof e.scope=="string"&&e.scope.length&&(a=[e.scope,a].join("::")),a},s=function(a,b){if(!a)throw"postMessage called with null message";var c=n?"post  ":"queue ";g(c+" message: "+JSON.stringify(a));if(!b&&!n)o.push(a);else{if(typeof e.postMessageObserver=="function")try{e.postMessageObserver(e.origin,a)}catch(d){g("postMessageObserver() raised an exception: "+d.toString())}e.window.postMessage(JSON.stringify(a),e.origin)}},t=function(a,b){g("ready msg received");if(n)throw"received ready message while in ready state.  help!";b==="ping"?j+="-R":j+="-L",u.unbind("__ready"),n=!0,g("ready msg accepted."),b==="ping"&&u.notify({method:"__ready",params:"pong"});while(o.length)s(o.pop());typeof e.onReady=="function"&&e.onReady(u)},u={unbind:function(a){if(k[a]){if(delete k[a])return!0;throw"can't delete method: "+a}return!1},bind:function(a,b){if(!a||typeof a!="string")throw"'method' argument to bind must be string";if(!b||typeof b!="function")throw"callback missing from bind params";if(k[a])throw"method '"+a+"' is already bound!";k[a]=b},call:function(a){if(!a)throw"missing arguments to call function";if(!a.method||typeof a.method!="string")throw"'method' argument to call must be string";if(!a.success||typeof a.success!="function")throw"'success' callback missing from call";var b={},c=[],e=function(a,d){if(typeof d=="object")for(var f in d){if(!d.hasOwnProperty(f))continue;var g=a+(a.length?"/":"")+f;typeof d[f]=="function"?(b[g]=d[f],c.push(g),delete d[f]):typeof d[f]=="object"&&e(g,d[f])}};e("",a.params);var g={id:d,method:r(a.method),params:a.params};c.length&&(g.callbacks=c),l[d]={callbacks:b,error:a.error,success:a.success},f[d]=q,d++,s(g)},notify:function(a){if(!a)throw"missing arguments to notify function";if(!a.method||typeof a.method!="string")throw"'method' argument to notify must be string";s({method:r(a.method),params:a.params})},destroy:function(){b(e.origin,typeof e.scope=="string"?e.scope:""),window.removeEventListener?window.removeEventListener("message",q,!1):window.detachEvent&&window.detachEvent("onmessage",q),n=!1,k={},m={},l={},e.origin=null,o=[],g("channel destroyed"),j=""}};return u.bind("__ready",t),setTimeout(function(){s({method:r("__ready"),params:"ping"},!0)},0),u}}}(),chan=undefined;function _create_iframe(a){var b=a.createElement("iframe");return b.style.display="none",a.body.appendChild(b),b.src=ipServer+"/register_iframe",b}function _open_relay_frame(a){var b=a.createElement("iframe");return b.setAttribute("name","browserid_relay"),b.setAttribute("src",ipServer+"/relay"),a.body.appendChild(b),b}function _open_window(){return window.open(ipServer+"/sign_in","_mozid_signin",isMobile?undefined:"menubar=0,location=0,resizable=0,scrollbars=0,status=0,dialog=1,width=520,height=350")}navigator.id.getVerifiedEmail=function(a){function b(){chan.destroy(),chan=undefined,c.close()}var c=_open_window(),d=window.document,e=_open_relay_frame(d);chan&&chan.destroy(),chan=Channel.build({window:e.contentWindow,origin:ipServer,scope:"mozid"}),chan.call({method:"getVerifiedEmail",success:function(c){a&&a(c),b()},error:function(c,d){a&&a(null),b()}})},navigator.id.preauthEmail=function(a,b,c){function d(){chan.destroy(),chan=undefined,e.body.removeChild(f)}var e=window.document,f=_create_iframe(e);chan&&chan.destroy(),chan=Channel.build({window:f.contentWindow,origin:ipServer,scope:"mozid"}),chan.call({method:"preauthEmail",params:a,success:function(a){b(a),d()},error:function(a,b){c&&c(a,b),d()}})},navigator.id.getSpecificVerifiedEmail=function(a,b,c,d){function e(){chan.destroy(),chan=undefined,b?f.body.removeChild(h):g.close()}var f=window.document,g;if(b){var h=_create_iframe(f);g=h.contentWindow}else _open_window(),_open_relay_frame(f);chan&&chan.destroy(),chan=Channel.build({window:g,origin:ipServer,scope:"mozid"}),chan.call({method:"getSpecificVerifiedEmail",params:[a,b],success:function(a){c&&c(a),e()},error:function(a,b){d&&d(a,b),e()}})},navigator.id.registerVerifiedEmail=function(a,b,c){function d(){chan.destroy(),chan=undefined,e.body.removeChild(iframe)}var e=window.document;iframe=_create_iframe(e),chan&&chan.destroy(),chan=Channel.build({window:iframe.contentWindow,origin:ipServer,scope:"mozid"}),chan.call({method:"registerVerifiedEmail",params:{email:a},success:function(a){console.log("registerVerifiedEmail channel returned: rv is "+a),b&&b(a),d()},error:function(a,b){c&&c(a,b),d()}})},navigator.id._getVerifiedEmailIsShimmed=!0}