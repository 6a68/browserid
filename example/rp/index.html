<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->

<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0; width=device-width;">
<title>
Persona Relying Party
</title>
<style type="text/css">

body { margin: auto; font: 13px/1.5 Helvetica, Arial, 'Liberation Sans', FreeSans, sans-serif; }
a:link, a:visited { font-style: italic; text-decoration: none; color: #008; }
a:hover { border-bottom: 2px solid black ; }
.title { font-weight: bold; text-align: center; margin: 1.5em auto 1.5em auto; }
.title h1 { font-size: 2em; }
.title h2 { font-size: 1.5em; }
.intro { font-size: 1.2em;  }
.specify, .session { font-size: 1.1em; padding-top: 2em; }
body div { width: 600px; margin: auto; }

pre {
  font-family: 'lucida console', monaco, 'andale mono', 'bitstream vera sans mono', consolas, monospace;
  border: 3px solid #666;
  -moz-border-radius: 4px;
  -webkit-border-radius: 4px;
  border-radius: 4px;
  padding: .5em;
  margin: .5em;
  color: #ccc;
  background-color: #333;
/*  white-space: pre;*/
  font-size: .9em;
  word-wrap: break-word;
}

.specify ul { padding-left: 0px; }
.specify li { list-style: none; }

@media screen and (max-width: 640px) {
  .intro, .output, .step {
    width: 90%;
  }
}

</style>
<script>
// first part of the async snippet. has to be loaded before other scripts relying on persona.
// if include.js is loaded async, does it need to be separate?
// yes I think, because the RP might require in a content script and get a 'navigator.id.foo is undefined' error.
if (navigator.id || navigator.mozId) { return; }
navigator.id = {}; navigator.idq = [];
function makeQueueable(funcName) {
  var f = function() { navigator.idq.push({func: funcName, args: arguments}) }
  f.isQueueable = true; // so we can check it was overwritten
  return f;
}
// stub out the API
navigator.id.get = makeQueueable('get');
navigator.id.getVerifiedEmail = makeQueueable('getVerifiedEmail');
navigator.id.logout = makeQueueable('logout');
navigator.id.request = makeQueueable('request');
navigator.id.watch = makeQueueable('watch');
</script>

</head>
<body>
<div class="title">
  <h1>Persona Test Relying Party</h1>
  <h2>navigator.id.watch</h2>
</div>

<div class="intro">
  This is a RP for testing, it allows you to drive the
  <tt>navigator.id.watch() &amp; navigator.id.request()</tt> calls manually to locally test Persona.  Looking to test <a href="/get.html">navigator.id.get</a>?
</div>

<div class="specify">
  <p><b>What flavor of assertion would you like?</b></p>
  <ul>
    <li>
      <input type="checkbox" id="privacyPolicy">
      <label for="privacyPolicy">Supply a privacy policy</label>
    </li><li>
      <input type="checkbox" id="termsOfService">
      <label for="termsOfService">Supply a ToS</label>
    </li><li>
      <input type="checkbox" id="siteName">
      <label for="siteName">Supply Site Name</label><br />
    </li><li>
      <input type="checkbox" id="siteLogo">
      <label for="siteLogo">Supply Site Logo</label><br />
    </li><li>
      <input type="checkbox" id="returnTo">
      <label for="returnTo">Supply returnTo</label><br />
    </li><li>
      <input type="checkbox" id="forceAuthentication">
      <label for="forceAuthentication">Force Authentication</label><br />
    </li><li>
      <input type="checkbox" id="forceIssuer">
      <label for="forceIssuer">Force Issuer to issuer.domain</label><br />
    </li><li>
      <input type="checkbox" id="allowUnverified">
      <label for="allowUnverified">Allow Unverified</label><br />
    </li>
  </ul>
    <button class="assertion">Get an assertion</button>
    <button class="logout">logout</button>
</div>

<div class="session">
  <p><b>Care to simulate a session?</b></p>
  <p>If you enter an email address or 'null' here, upon reload this value will
     be passed to .watch() as the first parameter.  This lets you test things like
     assertion generation suppression when the site and browser agree on who is logged in.
  </p>
  <input type="text" id="loggedInUser" width="80">
  <button class="update_session">Update "session"</button>
</div>

<div class="loginEvents">
  <h2>logins</h2>
  <pre> ... </pre>
</div>

<div class="logoutEvents">
  <h2>logouts</h2>
  <pre> ... </pre>
</div>

<div class="matchEvents">
  <h2>matches</h2>
  <pre> ... </pre>
</div>

<div class="readiness">
  <h2>readiness</h2>
  <pre> ... </pre>
</div>

</body>

<script src="jquery-min.js"></script>
<script>

try {
  var storage = localStorage;
}
catch(e) {
  // Fx with cookies disabled with blow up when trying to access localStorage.
  storage = {};
}


function loggit() {
  try {
    console.log.apply(console, arguments);
  } catch(e) {}
}

var serial = 1;

// a function to check an assertion against the server
function checkAssertion(assertion) {
  $.ajax({
    url: "/process_assertion",
    type: "post",
    dataType: "json",
    data: {
      assertion: assertion,
      audience: window.location.protocol + "//" + window.location.host,
      forceIssuer: $('#forceIssuer').attr('checked') ? "issuer.domain" : undefined,
      allowUnverified: $('#allowUnverified').attr('checked') ? true : false
    },
    success: function(data, textStatus, jqXHR) {
      var old = $(".loginEvents > pre").text() + "\n";
      $(".loginEvents > pre").text(old + JSON.stringify(data, null, 4));
    },
    error: function(jqXHR, textStatus, errorThrown) {
      var resp = jqXHR.responseText ? JSON.parse(jqXHR.responseText) : errorThrown;
      $(".loginEvents > pre").text(resp);
    }
  });
};

navigator.id.watch({
  loggedInUser: (storage.loggedInUser === 'null') ? null : storage.loggedInUser,
  onready: function () {
    loggit("onready");
    var txt = serial++ + ' navigator.id ready at ' + (new Date).toString();
    $(".readiness > pre").text(txt);
  },
  onlogin: function (assertion) {
    loggit("onlogin");
    var txt = serial++ + ' got assertion at ' + (new Date).toString();
    $(".loginEvents > pre").text(txt);

    checkAssertion(assertion);

    $(".specify button.assertion").removeAttr('disabled');
  },
  onlogout: function () {
    loggit("onlogout");
    var txt = serial++ + ' logout callback invoked at ' + (new Date).toString();
    $(".logoutEvents > pre").text(txt);
  },
  onmatch: function() {
    loggit("onmatch")
    var txt = serial++ + ' match callback invoked at ' + (new Date).toString();
    $(".matchEvents > pre").text(txt);
  }
});

$(document).ready(function() {
  $(".specify button.assertion").click(function() {
    $(".specify button.assertion").attr('disabled', 'true');

    navigator.id.request({
      privacyPolicy: $('#privacyPolicy').attr('checked') ? "/privacy.html" : undefined,
      termsOfService: $('#termsOfService').attr('checked') ? "/TOS.html" : undefined,
      siteName: $('#siteName').attr('checked') ? "Persona Test Relying Party" : undefined,
      siteLogo: $('#siteLogo').attr('checked') ? "/i/logo.png" : undefined,
      returnTo: $('#returnTo').attr('checked') ? "/postVerificationReturn.html" : undefined,
      experimental_forceAuthentication: $('#forceAuthentication').attr('checked') ? true : false,
      experimental_forceIssuer: $('#forceIssuer').attr('checked') ? "issuer.domain" : undefined,
      experimental_allowUnverified: $('#allowUnverified').attr('checked') ? true : false,
      oncancel: function() {
        loggit("oncancel");
        $(".specify button.assertion").removeAttr('disabled');
      }
    });
  });

  $(".specify button.logout").click(function() { navigator.id.logout() });

  $(".session button.update_session").click(function() {
    storage.loggedInUser = $.trim($('#loggedInUser').val());
    $(".session input").fadeOut(100).fadeIn(350);
  });
  $('#loggedInUser').val(storage.loggedInUser ? storage.loggedInUser : "");
});

</script>

<script>
// TODO: maybe a blog post on this stuff, eh?
// TODO: instead of just loading in regular flow, wait until 'onload' or other
//       event fires. this is possible, but tricky in IE8.
// WIP refs: 
//  disqus embed: http://help.disqus.com/customer/portal/articles/472097-universal-embed-code
//  ga embed: https://developers.google.com/analytics/devguides/collection/gajs/
//  meebo embed: https://github.com/meebo/embed-code/blob/master/embed-code.js
//  lightningjs embed (so crufty): https://github.com/olark/lightningjs/blob/master/lightningjs-embed.js
//  great SO answer on custom IE8 events, need to confirm accurate with wrox book: http://stackoverflow.com/questions/13435008/how-to-trigger-a-custom-javascript-event-in-ie8

/* to make onScriptLoaded smaller + look like something not to be tampered with,
   we can set some vars (nid = navigator.id, nidw = nid.watch, nidq = navigator.idq),
   then minify it:

   function onScriptLoaded(e){var t=navigator.id,n=t.watch,r=navigator.idq;return function(){
   var i=e.readyState;if(!i||/loaded|complete/.test(i)){var o=0;function u(){if(n.isQueueable){
   o++;if(o>200){throw new Error("include.js failed to load after 10 sec")}return setTimeout(u,50)
   }while(r.length){var i=r.shift();t[i.func].apply(navigator.id,i.args)}delete navigator.idq;
   e.onload=null;e.onreadystatechange=null}u()}}}

*/
function onScriptLoaded(s) {
  return function() {
    var rdyState = s.readyState;
    if (!rdyState || /loaded|complete/.test(rdyState)) {
      var pollCount = 0;
      function onParsed() {
        if (navigator.id.watch.isQueueable) {
          pollCount++;
          if (pollCount > 200) { throw new Error('include.js failed to load after 10 sec') }
          return setTimeout(onParsed, 50); // bail till ready, todo verify it's actually needed to wait for parse time.
        }
        while (navigator.idq.length) {
          var next = navigator.idq.shift();
          navigator.id[next.func].apply(navigator.id, next.args);
        }
        delete navigator.idq;
        s.onload = null;
        s.onreadystatechange = null;
      }
      onParsed()
    }
  };
}

var scr = document.createElement('script'); scr.async = true; scr.type = 'text/javascript';
scr.src = 'https://login.persona.org/include.js'; scr.onload = scr.onreadystatechange = onScriptLoaded(scr);
// GA snippet and 3pJS book
var entry = document.getElementsByTagName('script')[0]; entry.parentNode.insertBefore(scr, entry);
// cleaner, how disqus currently does it:
// (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(scr);
}
</script>
</html>
